---
title: "combine_plots"
author: "Catarina Pien"
date: "3/4/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls(all=TRUE))
library(dplyr)
library(ggplot2)
library(lubridate)
library(Polychrome)
library(readr)
library(here)
library(viridis)
```

To combine: 
- Species comp (zoop + drift)
- Season/WY (zoop + drift + chla)
- Inundation time series (zoop + drift)
- CPUE by season, wy (zoop + drift + chla + biovolume)

```{r}
root <- "WY2017_WY2019/data_figures"

# Proportional plot
driftProp <- read_csv(here::here(root,"ProportionalData.csv")) %>%
  mutate(fWY = case_when(fWY == "2017" ~ "WY17",
                         fWY == "2018" ~ "WY18",
                         fWY == "2019" ~ "WY19",
                         TRUE ~ as.character(fWY)))
zoopProp <- read_csv(here::here(root, "zoop_percent.csv"))%>%
  dplyr::rename(Station = Station.Code) %>%
  mutate(Org2 = ifelse(Org2 == "Acanthocyclops vernalis adult", "Acanthocyclops spp. adult", Org2))

# Bar plot station/WY
driftBar <- read_csv(here::here(root, "meanDriftBugs.csv"))%>%
  mutate(fWY = case_when(fWY == "2017" ~ "WY17",
                         fWY == "2018" ~ "WY18",
                         fWY == "2019" ~ "WY19",
                         TRUE ~ as.character(fWY)))

zoopBar <- read_csv(here::here(root, "zoop150.sum.csv"))%>%
  dplyr::rename(Station = Station.Code)

chlBar <- read_csv(here::here(root, "chlorophyll_bar.csv")) %>%
  dplyr::rename(fWY = WaterYear,
         Station = StationCode) %>%
  mutate(fWY = case_when(fWY == "2017" ~ "WY17",
                         fWY == "2018" ~ "WY18",
                         fWY == "2019" ~ "WY19",
                         TRUE ~ as.character(fWY))) %>%
  mutate(WYClass = case_when(fWY == "WY17" ~ "Wet",
                         fWY == "WY18" ~ "Average",
                         fWY == "WY19" ~ "Wet",
                         TRUE ~ as.character(NA))) 

phytoBar <- read_csv(here::here(root, "biovolume_bar.csv")) %>%
  dplyr::rename(fWY = WaterYear,
         Station = StationCode) %>%
  mutate(fWY = case_when(fWY == "2017" ~ "WY17",
                         fWY == "2018" ~ "WY18",
                         fWY == "2019" ~ "WY19",
                         TRUE ~ as.character(fWY)))%>%
  mutate(WYClass = case_when(fWY == "WY17" ~ "Wet",
                         fWY == "WY18" ~ "Average",
                         fWY == "WY19" ~ "Wet",
                         TRUE ~ as.character(NA))) 

# Inundation Plot
inun <- read_csv(here::here(root, "inundation2.csv")) %>%
  mutate(inunD = ifelse(Inundation == "FALSE", 0, 175),
    inunZ = ifelse(Inundation == "FALSE", 0, 3e05),
    inunC = ifelse(Inundation == "FALSE", 0, 60),
    inunP = ifelse(Inundation == "FALSE", 0, 3e07))
driftInun <- read_csv(here::here(root, "driftDailyCPUE.csv"))
zoopInun <- read_csv(here::here(root, "zoop150.sum1.csv"))%>%
  dplyr::rename(Station = Station.Code)
chlInun <- read_csv(here::here(root, "chlorophyll_inundation.csv")) %>%
  dplyr::rename(Station = StationCode)
phytoInun <- read_csv(here::here(root, "biovolume_inundation.csv"))%>%
  dplyr::rename(Station = StationCode)
  
```

```{r}
theme_ltreport <- theme_bw() + 
  theme(axis.text = element_text(size = 14),
                        axis.title.x = element_blank(),
                        strip.text = element_text(size = 13),
                        axis.text.x = element_text(angle = 90),
                        legend.title = element_text(size = 11),
                        legend.text = element_text(size = 9.5),
        legend.position = "top",
        axis.title.y = element_text(size = 10,
                                    margin = margin(l=3)))
```

```{r}
pal36 <- palette36.colors(36)
pal36 <- as.vector(t(pal36))
```

## Make Proportional Plots

Pre-steps: for each, took total dataset, calculated the proportion of each taxa per station/year grouping. Any taxa that was <3% of that station/year's CPUE was classified as "other." All the "others" were combined into one percentage. 

### Drift
```{r}
# Proportional
(plot_driftProp <- ggplot(driftProp, aes(x=fWY, y = Percent/100, fill = Order3)) + 
   geom_bar(stat = "identity", color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + 
  labs(title= "B) Drift Invertebrates", 
       y = "Proportional Catch Per Unit Effort", x = "Water Year") + 
   theme_ltreport + 
   theme(axis.text.x = element_text(angle = 45, vjust = 0.5), 
         legend.title = element_blank(),                                                      axis.title.y = element_blank()) +
    guides(fill=guide_legend(nrow=2)))

```

### Zoop
```{r}
zoopProp2 <- zoopProp %>%
  group_by(Station, WY, Org2) %>%
  summarize(totalPercent = sum(percent)/100)
# This one
(plot_zoopProp <- ggplot(zoopProp2, aes(x=WY, y = totalPercent, fill = Org2)) + 
   geom_bar(stat = "identity", color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + 
  labs(title= "A) Zooplankton", 
       y = "Proportional Catch Per Unit Effort", x = "Water Year") + 
   theme_ltreport + 
   theme(axis.text.x = element_text(angle = 45, vjust = 0.5), 
         legend.title = element_blank(),                                                      axis.title.y = element_blank())+
    guides(fill=guide_legend(nrow=3)))
```

### Combined
```{r}
library(ggpubr)
library(gridExtra)

(combined <- ggarrange(plot_zoopProp, plot_driftProp, nrow = 2))

annotated <- annotate_figure(combined, 
                left = text_grob("Proportional Catch Per Unit Effort", color = "black", rot = 90, size = 14))

annotated
```

```{r}
png(filename = paste("WY2017_WY2019/figures/fig_proportionalcombined.png"), res = 300, width = 8, height = 9, pointsize = 11, family = "sans", units = "in")
annotated
dev.off()
```


## Make WY/station bar plots
### Chlorophyll
```{r}
chlBar2<- chlBar %>% 
  dplyr::rename(WY = fWY) %>%
  dplyr::group_by(Station, WY, WYClass) %>%
  dplyr::summarize(meanChl = mean(Result, na.rm = TRUE),
            n = n(),
            sd = sd(Result, na.rm = TRUE),
            se = sd/sqrt(n))


(plot_barChl <- ggplot(chlBar2, aes(x = WY, y = meanChl, fill = WYClass)) + 
   geom_col()  + 
   geom_errorbar(aes(ymin = meanChl-se, ymax = meanChl + se), width = .2) +
    labs(title = "A) Chlorophyll a") +
 facet_wrap(~Station) + 
    scale_fill_manual(values = c("sandybrown", "lightsteelblue4")) + labs(x = "Water Year") +
    ylab(expression(paste("   Mean Daily \nChlorophyll a (mgL"^-1,")"))) +
  guides(fill = guide_legend(title = "Water Year Class")) + theme_ltreport + theme(legend.position = "top",                                                                     axis.text.x = element_blank()))
```

### Biovolume
```{r}
bvBar2<- phytoBar %>% 
  dplyr::rename(WY = fWY) %>%
  dplyr::group_by(Station, WY, WYClass) %>%
  dplyr::summarize(meanBV = mean(biovolume, na.rm = TRUE),
            n = n(),
            sd = sd(biovolume, na.rm = TRUE),
            se = sd/sqrt(n))


(plot_barPhyto <- ggplot(bvBar2, aes(x = WY, y = meanBV, fill = WYClass)) + 
   geom_col()  + 
   geom_errorbar(aes(ymin = meanBV-se, ymax = meanBV + se), width = .2) +
    labs(title = "B) Phytoplankton Biovolume Density") +
 facet_wrap(~Station) + scale_fill_manual(values = c("sandybrown", "lightsteelblue4")) + labs(x = "Water Year") +
    ylab(expression(paste("         Mean Daily \n Biovolume Density (μm"^3,"L"^-1,")"))) +
  labs(x = "Water Year") +
  guides(fill = guide_legend(title = "Water Year Class")) + 
    theme_ltreport + 
    theme(legend.position = "top",
  axis.text.x = element_blank()))
```


### Zoop
```{r}
zoopBar2<- zoopBar %>% 
  dplyr::group_by(Station, WY, WY.Class) %>% dplyr::summarize(meanCPUE = mean(daily.CPUE, na.rm = TRUE),
            sdCPUE = sd(daily.CPUE, na.rm = TRUE),
            n = n(),
            se = sdCPUE/sqrt(n))


(plot_barZoop <- ggplot(zoopBar2, aes(x = WY, y = meanCPUE, fill = WY.Class)) + 
   geom_col()  + 
   geom_errorbar(aes(ymin = meanCPUE-se, ymax = meanCPUE + se), width = .2) +
    labs(title = "C) Zooplankton") +
 facet_wrap(~Station) + scale_fill_manual(values = c("sandybrown", "lightsteelblue4")) + labs(x = "Water Year") + labs(x = "Water Year") +
    ylab(expression(paste("     Mean Daily \nCPUE (Count m"^-3,")")))+
  guides(fill = guide_legend(title = "Water Year Class")) + theme_ltreport + theme(legend.position = "top",
                                                                                   axis.text.x = element_blank()))
```

### Drift
```{r}
#Mean CPUE
(plot_barDrift <- ggplot(driftBar, aes(x = fWY, y = meanCPUE, fill = WYClass)) + 
   geom_col()  + 
   geom_errorbar(aes(ymin = meanCPUE-se, ymax = meanCPUE + se), width = .2) +
   labs(title = "D) Drift Invertebrates")+
 facet_wrap(~Station) + 
   scale_fill_manual(values = c("sandybrown", "lightsteelblue4")) + labs(x = "Water Year") +
  labs(x = "Water Year") +
    ylab(expression(paste("     Mean Daily \nCPUE (Count m"^-3,")")))+
  guides(fill = guide_legend(title = "Water Year Class")) + 
   theme_ltreport + theme(legend.position = "top"))
```


### Combined
```{r}
library(ggpubr)
library(gridExtra)
library(patchwork)

# (combinedBar <- ggarrange(plot_barChl, plot_barPhyto,plot_barZoop,  plot_barDrift,
#                           nrow = 4, common.legend = TRUE, heights = c(2,2,2,2.5), 
#                           align = "v"))
(combinedBar <- plot_barChl / plot_barPhyto / plot_barZoop / plot_barDrift + plot_layout(guides = 'collect') & theme(legend.position = 'bottom'))
# annotatedBar <- annotate_figure(combinedBar, 
#                 left = text_grob(expression(Catch~Per~Unit~Effort~(Count~m^-3)), color = "black", rot = 90, size = 14))
# 
# annotatedBar
```

```{r}
png(filename = paste("WY2017_WY2019/figures/fig_barcombined2.png"), res = 300, width = 7.5, height = 10, pointsize = 11, family = "sans", units = "in")
combinedBar
dev.off()

tiff(filename = paste("WY2017_WY2019/figures/fig_barcombined_final.tiff"), res = 300, width = 8, height = 10, pointsize = 11, family = "sans", units = "in", compression = "lzw")
combinedBar
dev.off()
```



## Make Inundation plots
### Chlorophyll
```{r}
color = c("gray82", "white")

(plot_inunChl <- ggplot() +
  geom_col(data = inun, aes(x = Date, y = inunC, fill = color, alpha = color)) +
  geom_line(data = chlInun, aes(x = Date, y = Result, linetype = Station, color = Station),size = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
   #scale_colour_manual(values = c("darkgreen", "hotpink3", "black")) + 
       scale_colour_viridis(discrete = TRUE) +
    scale_alpha_manual(values = c(1, 0), guide = "none") +
   scale_linetype_manual(values = c("dotted", "solid", "longdash"))+
  labs(title = "A) Chlorophyll a", y = expression(Chlorophyll~a~(mg~L^-1)), fill = "Inundation") +
 scale_fill_manual(values = color) +
    theme_bw() + 
  theme_ltreport + 
   theme(axis.title.x = element_blank(),
         legend.key=element_rect(colour="black"),
         axis.text.x = element_blank()))
```

### Phytoplankton
```{r}
(plot_inunPhyto <- ggplot() +
  geom_col(data = inun, aes(x = Date, y = inunP, fill = color, alpha = color)) +
  geom_line(data = phytoInun, aes(x = Date, y = biovolume, linetype = Station, color = Station), size = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
   #scale_colour_manual(values = c("darkgreen", "hotpink3", "black")) + 
      scale_colour_viridis(discrete = TRUE) +
    scale_alpha_manual(values = c(1, 0), guide = "none") +
   scale_linetype_manual(values = c("dotted", "solid", "longdash"))+
  labs(title = "B) Phytoplankton Biovolume Density", y = expression(Biovolume~Density~(μm^3~L^-1)), fill = "Inundation") +
 scale_fill_manual(values = color) +
    theme_bw() + 
  theme_ltreport + 
   theme(axis.title.x = element_blank(),
         legend.key=element_rect(colour="black"),
         axis.text.x = element_blank()))
```
### Zoop
```{r}
# picked 2nd and 3rd color of a 3-color viridis scale to match above
(plot_inunZoop <- ggplot() +
  geom_col(data = inun, aes(x = Date, y = inunZ, fill = color, alpha = color)) +
  geom_line(data = zoopInun, aes(x = Date, y = daily.CPUE, linetype = Station, color = Station), size = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
   scale_colour_manual(values = c(viridis(3)[2], viridis(3)[3])) + 
    scale_alpha_manual(values = c(1, 0), guide = "none") +
   
   scale_linetype_manual(values = c("solid", "longdash"))+
  labs(title = "C) Zooplankton", y = expression(CPUE~(Count~m^-3)), fill = "Inundation") +
 scale_fill_manual(values = color) +
    theme_bw() + 
  theme_ltreport + 
   theme(axis.title.x = element_blank(),
         legend.key=element_rect(colour="black"),
         axis.text.x = element_blank()))
```

### Drift
```{r}

# Total CPUE
(plot_inunDrift <- ggplot() +
  geom_col(data = inun, aes(x = Date, y = inunD, fill = color, alpha = color)) +
  geom_line(data = driftInun, aes(x = Date, y = CPUEDaily, linetype = Station, color = Station), size = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
    scale_colour_manual(values = c(viridis(3)[2], viridis(3)[3])) +
    scale_alpha_manual(values = c(1, 0), guide = "none") +
    
   scale_linetype_manual(values = c("solid", "longdash"))+
  labs(title = "D) Drift Invertebrates", y = expression(CPUE~(Count~m^-3))) +
 scale_fill_manual(values = color) +
    theme_bw() + 
  theme_ltreport + 
   theme(axis.title.x = element_blank(),
         legend.key=element_rect(colour="black")))
  #scale_fill_manual(name = "Inundation", values = c("light blue", "white"), guide = guide_legend(override.aes = list(color = c("light blue", "white")))))
```





### Combined
```{r}
library(ggpubr)
library(gridExtra)

(combinedInun <- ggarrange(plot_inunChl, plot_inunPhyto,plot_inunZoop, plot_inunDrift,  nrow = 4, common.legend = TRUE, heights = c(2,2,2,2.7), align = "v"))

# annotatedInun <- annotate_figure(combinedInun, 
#                 left = text_grob(expression(Catch~Per~Unit~Effort~(Count~m^-3)), color = "black", rot = 90, size = 14))
# 
# annotatedInun
```

```{r}
png(filename = paste("WY2017_WY2019/figures/fig_inuncombined.png"), res = 300, width = 6.5, height = 9, pointsize = 11, family = "sans", units = "in")
combinedInun

dev.off()
```


Grid arrange separate legend
```{r}
# save legend separately for final figure
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(plot)

# Annotate
plot21NR_avg3 <- annotate_figure(plot21NR_avg2, 
                left = text_grob("21°C", color = "black", rot = 90, size = 14))

# Plot
plotComb <- grid.arrange(legend, plot, plot2, plot3, 
                            nrow = 3,
            layout_matrix = rbind(c(1,1,2), c(3,4,5)), 
             widths = c(3.23,3,2.85), heights = c(0.75,3))
dev.off()
```

## Export code
```{r}
tiff(filename = paste("WY2017_WY2019/figures/fig_drift4b_totalcpuebyinundation.tiff"), res = 300, width = 7, height = 5, pointsize = 11, family = "sans", units = "in", compression = "lzw")
inunDriftAll
dev.off()
```

