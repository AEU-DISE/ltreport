---
title: "DriftAnalysis"
author: "Catarina Pien"
date: "5/11/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Last updated 6 August, 2021 by Catarina Pien

```{r setup, include=FALSE}
rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate)
library(viridis)
library(plotly)
library(Polychrome)
library(here)
```

```{r}
root <- "WY2016_WY2019/data_clean"

driftBugs <- read_csv(here::here(root, "clean_drift_bugs.csv"))
#driftBugsComplete <- read.csv(here::here(root, "data_clean", "clean_drift_bugs_complete.csv"))%>%
#  mutate(Date = lubridate::ymd(Date))# zeroes filled in
driftDailyCPUE <- read_csv(here::here(root,"clean_drift_daily_cpue.csv"))

driftFamilyAbund <-read_csv(here::here(root, "clean_drift_family_abundant.csv"))%>%
  mutate(Date = lubridate::ymd(Date))

driftOrderAbund<- read_csv(here::here(root, "clean_drift_order_abundant.csv"))%>%
  mutate(Date = lubridate::ymd(Date)) %>%
  ungroup()

driftOrderIEP <- read_csv(here::here(root, "clean_drift_order_iep.csv"))
driftInund <- read_csv(here::here(root, "clean_drift_inund_sumCPUE.csv"))
inundation <- read_csv(here::here(root, "inundation.csv") )
inundation2 <- read_csv(here::here(root, "inundation2.csv")) %>%
  mutate(Date = lubridate::ymd(Date))
  
```

Mean Daily sum of CPUE by WY
```{r}
meanDriftBugs <- driftDailyCPUE %>%
  group_by(fWY, WYClass, Station) %>%
  summarize(meanCPUE = mean(CPUEDaily, na.rm = TRUE),
            sdCPUE = sd(CPUEDaily, na.rm = TRUE),
            n = n(),
            se = sdCPUE/sqrt(n))
```

Lists
```{r}
#n = [22]
familyAbund <- unique(driftFamilyAbund$Family)

#n = [20]
orderAbund <- unique(driftOrderAbund$Order)

orderAbund2 <- c( "Amphipoda","Coleoptera","Diptera","Enchytraeida","Hemiptera","Hygrophila","Hymenoptera")

orderIEP <- c("Diptera","Hemiptera","Amphipoda","Hymenoptera","Coleoptera", "Collembola")
```

Theme
```{r}
theme_ltreport <- theme_bw() + 
  theme(axis.text = element_text(size = 14),
                        axis.title = element_text(size = 14),
                        strip.text = element_text(size = 13),
                        axis.text.x = element_text(angle = 90),
                        legend.title = element_text(size = 12),
                        legend.text = element_text(size = 12))
```

# Useful info
```{r}
min(driftDailyCPUE$CPUEDaily)
max(driftDailyCPUE$CPUEDaily)
```




# Make plots

Total CPUE by Station and Water Year 
```{r}
#Total CPUE
(sumCPUE <- ggplot(driftDailyCPUE, aes(x = fWY, y = CPUEDaily, fill = WYClass)) + geom_col()  + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE, option = "cividis", begin = 1, end = 0) + labs(x = "Water Year", y = expression(Total~CPUE~(Count~m^-3))) +
  guides(fill = guide_legend(title = "Water Year Class")) + theme_ltreport + theme(legend.position = "top"))
```


Export
```{r}
# tiff(filename = "figures/fig_drift1_totalcpuebystationyear.tiff", res = 300, width = 5, height = 4, pointsize = 11, family = "sans", units = "in", compression = "lzw")
# sumCPUE
# dev.off()
```

1. Mean CPUE by WY and Station
# Summed daily CPUE, meaned over the year
```{r}
#Mean CPUE
(meanCPUE <- ggplot(meanDriftBugs, aes(x = fWY, y = meanCPUE, fill = WYClass)) + 
   geom_col()  + 
   geom_errorbar(aes(ymin = meanCPUE-se, ymax = meanCPUE + se), width = .2) +
 facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE, option = "cividis", begin = 1, end = 0) + labs(x = "Water Year", y = expression(Mean~Daily~CPUE~(Count~m^-3))) +
  guides(fill = guide_legend(title = "Water Year Class")) + theme_ltreport + theme(legend.position = "top"))
```

Export
```{r}
tiff(filename = "figures/fig_drift1a_meancpuebystationyear.tiff", res = 300, width = 5, height = 4, pointsize = 11, family = "sans", units = "in", compression = "lzw")
meanCPUE
dev.off()
```

*CPUE is lower in SHR compared with STTD, with much greater CPUE in wet years in STTD, slightly greater CPUE in dry year in SHR.*

2. Inundation/no inundation-mean CPUE
```{r}
meanDriftBugsInundation <- driftDailyCPUE %>%
  group_by(fWY, WYClass, Station, Inundation) %>%
  summarize(meanCPUE = mean(CPUEDaily, na.rm = TRUE))

(meanCPUEinund <- ggplot(meanDriftBugsInundation, aes(x = Inundation, y = meanCPUE, fill = Station)) + geom_col()  + facet_wrap(~fWY) + scale_fill_viridis(discrete = TRUE, option = "cividis", begin = 1, end = 0) + labs(x = "Inundation", y = expression(Total~CPUE~(Count~m^-3))) +
  guides(fill = guide_legend(title = "Station")) + theme_ltreport + theme(legend.position = "top"))
```

Export
```{r}
# tiff(filename = "figures/fig_drift2_meancpuebystationyearinund.tiff", res = 300, width = 6, height = 4, pointsize = 11, family = "sans", units = "in", compression = "lzw")
# 
# meanCPUEinund
# dev.off()
```

*Greater CPUE during inundation periods for 2017 and 2018, but not 2019.*


### By Order

#### Year

Calculate Abundance by Station and Water Year
```{r}
OrderAbund <- driftOrderAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDaily)) %>%
  ungroup() %>%
  group_by(Station, fWY, totalCPUE, Order) %>%
  summarize(meanCPUE = mean(CPUEDaily),
            sumCPUE = sum(CPUEDaily),
    propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))

```

WY - Order by Station
3. Proportional Abundance (Order) by WY and Station
(included in report)
```{r}
pal36 <- palette36.colors(36)
pal36 <- as.vector(t(pal36))

# sum CPUE
ggplot(OrderAbund, aes(fWY, sumCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + theme_ltreport + theme(axis.text.x = element_text(angle = 90))

# mean CPUE
ggplot(OrderAbund, aes(fWY, meanCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + theme_ltreport + theme(axis.text.x = element_text(angle = 90))

# Proportional
propOrder <- ggplot(OrderAbund, aes(x=fWY, y = propCPUE/100, fill = Order)) + geom_bar(stat = "identity", color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + 
  labs(y = "Proportional Catch Per Unit Effort", x = "Water Year") + theme_ltreport + theme(axis.text.x = element_text(angle = 90))
```

Export
```{r}
tiff(filename = "figures/fig_drift3_ordercomposition.tiff", res = 300, width = 6.5, height = 4.55, pointsize = 11, family = "sans", units = "in", compression = "lzw")
propOrder
dev.off()
```

#### Season - Filtered Orders

```{r}
Season1Order <- driftOrderAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDaily)) %>%
  ungroup() %>%
  select(c(Station, fWY, Season1, Order, CPUEDaily, totalCPUE)) %>%
  group_by(Station, fWY, Season1, Order) %>%
  summarize(sumCPUE = sum(CPUEDaily),
            meanCPUE =  mean(CPUEDaily),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))

Season2Order <- driftOrderAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDaily)) %>%
  ungroup() %>%
  select(c(Station, fWY, Season2, Order, CPUEDaily, totalCPUE)) %>%
  group_by(Station, fWY, Season2, Order) %>%
  summarize(sumCPUE = sum(CPUEDaily),
            meanCPUE =  mean(CPUEDaily),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))

Season3Order <- driftOrderAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDaily)) %>%
  ungroup() %>%
  select(c(Station, fWY, Season3, Order, CPUEDaily, totalCPUE)) %>%
  group_by(Station, fWY, Season3, Order) %>%
  summarize(sumCPUE = sum(CPUEDaily),
            meanCPUE =  mean(CPUEDaily),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))
```

##### Sherwood
```{r}
Season1_SHR <- Season1Order %>%
  filter(Station == "SHR") %>%
  #filter(Order %in% orderIEP) %>%
  group_by(Order) %>%
  mutate(CPUEsc = scale(sumCPUE))

Season3_SHR <- Season3Order %>%
  filter(Station == "SHR") %>%
  #filter(Order %in% orderIEP) %>%
  group_by(Order) %>%
  mutate(CPUEsc = scale(sumCPUE))
```

```{r}
ggplot(Season1_SHR, aes(x = Season1, y = sumCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_SHR, aes(x = Season1, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport

ggplot(Season3_SHR, aes(x = Season3, y = sumCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season3_SHR, aes(x = Season3, y = meanCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season3_SHR, aes(x = Season3, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport
```

##### Screw trap
```{r}
Season1_STTD <- Season1Order %>%
  filter(Station == "STTD") %>%
  #filter(Order %in% orderIEP) %>%
  group_by(Order) %>%
  mutate(CPUEsc = scale(sumCPUE))

Season3_STTD <- Season3Order %>%
  filter(Station == "STTD") %>%
  #filter(Order %in% orderIEP) %>%
  group_by(Order) %>%
  mutate(CPUEsc = scale(sumCPUE))
```

```{r}
ggplot(Season1_STTD, aes(x = Season1, y = sumCPUE, fill = Order)) + geom_col(col= "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_STTD, aes(x = Season1, y = meanCPUE, fill = Order)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_STTD, aes(x = Season1, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport

ggplot(Season3_STTD, aes(x = Season3, y = sumCPUE, fill = Order)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season3_STTD, aes(x = Season3, y = meanCPUE, fill = Order)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season3_STTD, aes(x = Season3, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport
```

#### Month 
```{r}
MonthOrder <- driftOrderAbund %>%
  filter(Order %in% orderAbund)%>%
  group_by(Station, fWY, fMonth, Order) %>%
  summarize(sumCPUE = sum(CPUEDaily),
            meanCPUE = round(mean(CPUEDaily),3)) %>%
  unique() %>%
  ungroup() %>%
  complete(fMonth, nesting(fWY, Station, Order), fill = list(sumCPUE = 0,
                                                             meanCPUE = 0))
```

##### Sherwood
Abundance by Month - Filtered Orders to last report
```{r}
MonthFilt_SHR <- MonthOrder %>%
  filter(Station == "SHR") %>%
  group_by(fMonth) %>%
  mutate(CPUEsc = scale(sumCPUE))

ggplot(MonthFilt_SHR, aes(x = fMonth, y = sumCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "Sherwood") + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(MonthFilt_SHR, aes(x = fMonth, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + labs(title = "Sherwood") + theme_ltreport

```

##### Screw trap
Abundance by Month - Filtered Orders to last report
```{r}
MonthFilt_STTD <- MonthOrder %>%
  filter(Station == "STTD") %>%
  group_by(fMonth) %>%
  mutate(CPUEsc = scale(sumCPUE))

ggplot(MonthFilt_STTD, aes(x = fMonth, y = sumCPUE, fill = Order)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "Screw Trap") + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(MonthFilt_STTD, aes(x = fMonth, y = Order, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + labs(title = "Screw Trap") + theme_ltreport
```


### By Family

Abundance all together
```{r}
# These are the ones in at least 90% samples
FamilyLastReport <- driftBugs %>%
 filter(Family %in% familyAbund) %>%
  group_by(Station, fWY, Season1, Season2, fMonth, Family) %>%
  summarize(occurrence = n(),
            totalCPUE = sum(CPUE))

# For looking at what is in "others"
driftFamily1 <- driftBugs %>%
  filter(!Family %in% familyAbund) %>%
  group_by(Station,fWY, Season1, Season2, Order, Family) %>%
  summarize(occurrence = n(),
            totalCPUE = sum(CPUE)) %>%
  select(c(Station, fWY,  Family, everything()))

# These are the "others"
driftFamily2 <- driftBugs %>%
  filter(!Family %in% familyAbund) %>%
  group_by(Station,fWY,Season1, Season2, fMonth) %>%
  summarize(occurrence = n(),
            totalCPUE = sum(CPUE),
            Family = "Other") %>%
  select(c(Station,fWY,Season1, Season2,  fMonth, Family, everything()))

# Bind other with the rest
driftFamilyF <- rbind(FamilyLastReport, driftFamily2) %>%
  arrange(Station, fWY,  Season1, Season2, fMonth, Family)


```

#### Year
```{r}
FamilyAbund <- driftFamilyAbund %>%
  filter(Family %in% familyAbund)%>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDay)) %>%
  ungroup() %>%
  group_by(Station, fWY, Family) %>%
  summarize(sumCPUE = sum(CPUEDay),
            meanCPUE = round(mean(CPUEDay),3),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup()

# Species composition, by Family
ggplot(FamilyAbund, aes(x = fWY, y = sumCPUE, fill = Family)) + geom_col(color = "black") + scale_fill_manual(values = pal36) + facet_wrap(~Station) + theme_ltreport

# Proportional
ggplot(FamilyAbund, aes(x=fWY, y = propCPUE/100, fill = Family)) + geom_bar(stat = "identity", color = "black") + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + theme_ltreport + theme(axis.text.x = element_text(angle = 90))
```

#### Season - Filtered Family

```{r}
Season1Family <- driftFamilyAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDay)) %>%
  ungroup() %>%
  select(c(Station, fWY, Season1, Family, CPUEDay, totalCPUE)) %>%
  group_by(Station, fWY, Season1, Family) %>%
  summarize(sumCPUE = sum(CPUEDay),
            meanCPUE =  mean(CPUEDay),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))

Season2Family <- driftFamilyAbund %>%
  group_by(Station, fWY) %>%
  mutate(totalCPUE = sum(CPUEDay)) %>%
  ungroup() %>%
  select(c(Station, fWY, Season2, Family, CPUEDay, totalCPUE)) %>%
  group_by(Station, fWY, Season2, Family) %>%
  summarize(sumCPUE = sum(CPUEDay),
            meanCPUE =  mean(CPUEDay),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup() %>%
  arrange(Station, fWY, desc(propCPUE))
```

##### Sherwood
```{r}
Season1_SHR <- Season1Family %>%
  filter(Station == "SHR") %>%
  #filter(Family %in% FamilyIEP) %>%
  group_by(Family) %>%
  mutate(CPUEsc = scale(sumCPUE))

Season2_SHR <- Season2Family %>%
  filter(Station == "SHR") %>%
  #filter(Family %in% FamilyIEP) %>%
  group_by(Family) %>%
  mutate(CPUEsc = scale(sumCPUE))
```

```{r}
ggplot(Season1_SHR, aes(x = Season1, y = sumCPUE, fill = Family)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_SHR, aes(x = Season1, y = Family, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport

ggplot(Season2_SHR, aes(x = Season2, y = sumCPUE, fill = Family)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season2_SHR, aes(x = Season2, y = meanCPUE, fill = Family)) + geom_col(color = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season2_SHR, aes(x = Season2, y = Family, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport
```

##### Screw trap
```{r}
Season1_STTD <- Season1Family %>%
  filter(Station == "STTD") %>%
  #filter(Family %in% FamilyIEP) %>%
  group_by(Family) %>%
  mutate(CPUEsc = scale(sumCPUE))

Season2_STTD <- Season2Family %>%
  filter(Station == "STTD") %>%
  #filter(Family %in% FamilyIEP) %>%
  group_by(Family) %>%
  mutate(CPUEsc = scale(sumCPUE))
```

```{r}
ggplot(Season1_STTD, aes(x = Season1, y = sumCPUE, fill = Family)) + geom_col(col= "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_STTD, aes(x = Season1, y = meanCPUE, fill = Family)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season1_STTD, aes(x = Season1, y = Family, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport

ggplot(Season2_STTD, aes(x = Season2, y = sumCPUE, fill = Family)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season2_STTD, aes(x = Season2, y = meanCPUE, fill = Family)) + geom_col(col = "black") + facet_wrap(~fWY) + theme_bw() + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(Season2_STTD, aes(x = Season2, y = Family, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + theme_bw() + theme_ltreport
```


#### Month 
```{r}
MonthFamily <- driftFamilyAbund %>%
  filter(Family %in% familyAbund)%>%
  mutate(totalCPUE = sum(CPUEDay)) %>%
  ungroup() %>%
  group_by(Station, fWY, fMonth, Family) %>%
  summarize(sumCPUE = sum(CPUEDay),
            meanCPUE = round(mean(CPUEDay),3),
            propCPUE = sumCPUE/totalCPUE*100) %>%
  unique() %>%
  ungroup()
```

##### Sherwood
```{r}
MonthFamily_SHR <- MonthFamily %>%
  filter(Station == "SHR") %>%
    group_by(fMonth) %>%
  mutate(CPUEsc = scale(sumCPUE))

ggplot(MonthFamily_SHR, aes(x = fMonth, y = sumCPUE, fill = Family)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "Sherwood") + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(MonthFamily_SHR, aes(x = fMonth, y = Family, fill = sumCPUE)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + labs(title = "Sherwood") + theme_ltreport
```

##### Screw trap
```{r}
MonthFamily_STTD <- MonthFamily %>%
  filter(Station == "STTD") %>%
  group_by(fMonth) %>%
  mutate(CPUEsc = scale(sumCPUE))

ggplot(MonthFamily_STTD, aes(x = fMonth, y = sumCPUE, fill = Family)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "Screw Trap") + scale_fill_manual(values = pal36) + theme_ltreport

ggplot(MonthFamily_STTD, aes(x = fMonth, y = Family, fill = CPUEsc)) + geom_tile() + facet_wrap(~fWY) + scale_fill_viridis() + labs(title = "Screw Trap") + theme_ltreport
```

Diptera, Hemiptera, Amphipoda, Hymenoptera, Coleoptera, Collembola, All other 

Compared to other lower trophic groups, drift invertebrate densities were much more variable across locations and across years, with the highest densities occurring primarily in winter and spring (Figure 3D).  Drift invertebrate densities showed the greatest differences between sampling locations in the higher outflow years of 2011 and 2016, during which extended floodplain inundation of the Yolo Bypass likely contributed to much higher densities of Diptera (Figures 3D and 8).  High densities of Diptera, an important food source for juvenile Chinook Salmon, in the Yolo Bypass during floodplain inundation have also been observed by Schemel et al. (2004) and Benigno and Sommer (2008).  Diptera made up over 60% of the Yolo Bypass drift invertebrate composition in winter 2011 and over 50% of the composition following the late floodplain inundation period in March of 2016 (Figure 8B).  Apart from 2014, spring drift invertebrate community densities were significantly different across sampling years between the Yolo Bypass and Sacramento River (ANOSIM p > 0.05, R value ≥ 0.3).  In all years, taxa orders Hemiptera (i.e. true bugs) and Diptera were top contributors to the differences in community composition between locations (SIMPER, ≥ 5% Hemiptera and ≥ 7% Diptera of taxa dissimilarity contribution).  The Diptera family Chironomidae (i.e. midges) was a primary contributor to the drift invertebrate community differences between sampling locations, especially in the highest outflow year of 2011.  In spring 2011, the higher densities of Diptera in the Yolo Bypass contributed to over 15% of the SIMPER taxa dissimilarity between the Sacramento River, with family Chironomidae making up 8% of that total dissimilarity contribution.  Benigno and Sommer (2008) also found that initial flood pulses in the Yolo Bypass are often dominated by chironomids emerging from sediments throughout the floodplain.



#### By terrestrial/aquatic

```{r}

# fWY and Station
ggplot(driftBugs, aes(fWY, CPUE, fill = Category)) + geom_col() + facet_wrap(~Station) +
  scale_fill_manual(values = pal36) + theme_bw() + theme(axis.text.x = element_text(angle = 90)) + theme_ltreport
  

MonthCategory_SHR <- driftBugs %>%
  filter(Station == "SHR",
         !is.na(Category)) %>%
  group_by(fWY, fMonth, Category) %>%
  summarize(totalCPUE = sum(CPUE)) %>%
  mutate(CPUEsc = scale(totalCPUE))

ggplot(MonthCategory_SHR, aes(fMonth, totalCPUE, fill = Category)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "SHR") +
  scale_fill_manual(values = pal36) + theme_ltreport + theme(axis.text.x = element_text(angle = 90))
  
MonthCategory_STTD <- driftBugs %>%
  filter(Station == "STTD",
         !is.na(Category)) %>%
  group_by(fWY, fMonth, Category) %>%
  summarize(totalCPUE = sum(CPUE)) %>%
  mutate(CPUEsc = scale(totalCPUE))
  
ggplot(MonthCategory_STTD, aes(fMonth, totalCPUE, fill = Category)) + geom_col(color = "black") + facet_wrap(~fWY) + labs(title = "STTD") +
  scale_fill_manual(values = pal36) + theme_ltreport + theme(axis.text.x = element_text(angle = 90))
```


### Add Inundation
Plot inundation with datetime vs. cpue 
- color by order, family
- added 10 days to inundation=yes for time for outflow
```{r}
# merged inundation and sampling
driftBugs$Date <- date(driftBugs$Datetime)

driftBugsOrder <- driftOrderAbund %>%
    filter(Station == "STTD")

driftBugsOrder2 <- driftOrderIEP %>%
  filter(Station == "STTD")


# Relationship
ggplot(driftInund, aes(x = Inundation, y = CPUEDaily)) + geom_violin(aes(fill = Inundation)) + theme_ltreport

```

```{r}
inundation2$color = ifelse(inundation2$Inundation == TRUE, "Inundation", "No Inundation")

colors <- data.frame(Inundation = c("Inundation", "No Inundation"), Color = c("light blue", "white"))
```

Figure 4. Inundation vs CPUE all
Export
```{r}
# Total CPUE
(inunDriftAll <- ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_n), color = "light blue") +
  geom_line(data = driftDailyCPUE, aes(x = Date, y = CPUEDaily)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(y = expression(CPUE~(Count~m^-3))) +
 # scale_fill_manual(limits = names(inundation2$Inundation_f), values = inundation2$color) +
  theme_ltreport + 
   theme(axis.title.x = element_blank()))
  #scale_fill_manual(name = "Inundation", values = c("light blue", "white"), guide = guide_legend(override.aes = list(color = c("light blue", "white")))))

tiff(filename = "figures/fig_drift4_totalcpuebyinundation.tiff", res = 300, width = 7, height = 5, pointsize = 11, family = "sans", units = "in", compression = "lzw")
inunDriftAll
dev.off()
```



#### Order
```{r}
# Order1
ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_mean), color = "grey86") +
  geom_line(data = driftBugsOrder, aes(x = Date, y = CPUEDaily, color = Order)) +
  theme_ltreport

# Order2
Order2plot <- ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_mean), color = "grey86") +
  geom_line(data = driftBugsOrder2, aes(x = Date, y = meanCPUE, color = Order)) + 
  scale_x_date(date_breaks = "6 months") +
  theme_ltreport
Order2plot
ggplotly(Order2plot)
```

```{r}
#Mean by order-month-year
OrderMean <- driftOrderAbund %>%
  filter(Order %in% orderAbund2)%>%
  mutate(YrMon = zoo::as.yearmon(Date)) %>%
  group_by(Station, YrMon, Order) %>%
  summarize(meanDate = mean(Date),
    sumCPUE = sum(CPUEDaily),
            meanCPUE=mean(CPUEDaily)) 
STTDMean <- filter(OrderMean, Station == "STTD")
SHRMean <- filter(OrderMean, Station == "SHR")


```

Export
```{r}
(inunDriftAbund <- ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_mean), color = "grey86") +
  geom_line(data = STTDMean, aes(x = meanDate, y = meanCPUE, color = Order)) + 
   geom_point(data = STTDMean, aes(x = meanDate, y = meanCPUE, color = Order)) +
   labs(y = expression(Mean~CPUE~(Count~m^-3))) + scale_color_viridis(discrete = TRUE, option = "plasma") + scale_x_date(date_breaks = "3 months", date_label = "%b-%Y") +
     theme_bw() + 
  theme_ltreport +
   theme(axis.title.x = element_blank()))

tiff(filename = "figures/fig_drift5_Abundcpuebyinundation_STTD.tiff", res = 300, width = 7, height = 5, pointsize = 11, family = "sans", units = "in", compression = "lzw")
inunDriftAbund
dev.off()
```

Time series Sherwood plot

```{r}
(SHRDriftTime <- ggplot() +
  geom_line(data = SHRMean, aes(x = meanDate, y = meanCPUE, color = Order)) +
   geom_point(data = SHRMean, aes(x = meanDate, y = meanCPUE, color = Order, shape = Order)) +
   labs(y = expression(Mean~CPUE~(Count~m^-3))) + scale_color_viridis(discrete = TRUE, option = "plasma") + scale_x_date(date_breaks = "3 months", date_label = "%b-%Y") +
  theme_bw() + 
  theme_ltreport +
   theme(axis.title.x = element_blank()))

tiff(filename = "figures/fig_drift6_Abundcpuebyinundation_SHR.tiff", res = 300, width = 7, height = 5, pointsize = 11, family = "sans", units = "in", compression = "lzw")
SHRDriftTime
dev.off()
```

Drift time series plot 
* This one
```{r}
(DriftTime <- ggplot() +
   geom_col(data = inundation2, aes(x = Date, y = Inundation_mean), color = "grey86") +
  geom_line(data = OrderMean, aes(x = meanDate, y = meanCPUE, color = Order)) +
   geom_point(data = OrderMean, aes(x = meanDate, y = meanCPUE, color = Order, shape = Order), size = 1.5) +
   labs(y = expression(Mean~CPUE~(Count~m^-3))) + 
   scale_color_viridis(discrete = TRUE, option = "plasma") + scale_x_date(date_breaks = "3 months", date_label = "%b-%Y") +
   facet_grid(Station~., scales = "free_y") +
  theme_bw() + 
  theme_ltreport +
  theme(axis.title.x = element_blank()))
```



```{r}
tiff(filename = "figures/fig_drift6_Abundcpuebyinundation_Station.tiff", res = 300, width = 7, height = 5.5, pointsize = 11, family = "sans", units = "in", compression = "lzw")
DriftTime
dev.off()
```



#### Family
```{r}
# Family1
Fam1plot <- ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_log), color = "grey85") +
  geom_line(data = driftBugsFamily, aes(x = Date, y = log(sumCPUE+1), color = Family)) + 
  scale_x_date(date_breaks = "6 months") +
  theme_ltreport
Fam1plot
plotly::ggplotly(Fam1plot)
# Family2
Fam2plot  <-  ggplot() +
  geom_col(data = inundation2, aes(x = Date, y = Inundation_log)) +
  geom_point(data = driftBugsFamily2, aes(x = Date, y = log(sumCPUE+1), color = Family)) + 
  geom_line(data = driftBugsFamily2, aes(x = Date, y = log(sumCPUE+1), color = Family)) +
  scale_x_date(date_breaks = "6 months") +
  theme_ltreport
ggplotly(Fam2plot)
```

Summary: We definitely see Chironomidae/Diptera peaking during inundation. Corixidae also seems to peak right after inundation. Possibly Hyallelidae, but pretty variable throughout the year. Possibly Dytiscidae right at the beginning of inundation? Possibly Ceratopogonidae and Corophiidae?
