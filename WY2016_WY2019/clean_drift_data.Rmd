---
title: "clean_drift_data"
author: "Catarina Pien"
date: "12/13/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate)
library(viridis)
library(plotly)
library(readr)
library(here)
```

Read in original data
```{r}
root <- "WY2016_WY2019"
drift0 <- read.csv(here::here(root, "data_raw", "Drift_data_20210420.csv"))
taxonomy <- read.csv(here::here(root, "data_raw","DriftTaxonomy.csv"))
inundation <- read.csv(here::here(root, "data_raw", "Yolo_Bypass_Inundation1998-2021.csv"))
```

Datetimes
```{r}
drift0 <- drift0 %>%
  mutate(fWY = factor(WY),
         fMonth = factor(month(Datetime),levels = c("10", "11", "12", "1", "2", "3","4", "5", "6", "7", "8", "9")),
         Date = date(Datetime)) %>%
  filter(is.na(FlagSamp)| FlagSamp!=3,
         ConditionCode < 3) # Remove bad samples

inundation$Date <- ymd(inundation$Date)
inundation <- inundation %>%
  mutate(Year = year(Date),
         Month = month(Date),
         WY = ifelse(month(Date) > 9, Year + 1, Year))
```

Filter data and add season, category

Season 1: Wet (10-3), Dry (4-9)
Season 2: Winter (10-1), Spring (2-5), SummerFall (6-9)
Season 3: Fall(10-12), Winter(1-3), Spring (4-6), Summer (7-9)
```{r}
drift <- drift0 %>% 
  filter(WY > 2016 & WY < 2020) %>%
  left_join(taxonomy) %>%
  mutate(Category = replace(Category, Category == "Aquatic Insects", "Aquatic Insect"),
         Category = replace(Category, Category == "Aquatic Non-Insects", "Aquatic Non-Insect"),
         Category = replace(Category, Category == "Terrestrial Insects", "Terrestrial Insect"),
         Category = replace(Category, Category == "Terrestrial Non-Insects", "Terrestrial Non-Insect"))%>%
  mutate(Season2 = ifelse(fMonth %in% c("10", "11", "12", "1" ), "Winter", 
                                       ifelse(fMonth %in% c("2", "3", "4", "5"), "Spring", "SummerFall")),
         Season2 = factor(Season2, levels = c("Winter", "Spring", "SummerFall"))) %>%
  mutate(Season1 = ifelse(fMonth %in% c ("10", "11", "12", "1", "2", "3"), "Wet", "Dry"),
         Season1 = factor(Season1, levels = c("Wet", "Dry"))) %>%
  mutate(Season3 = ifelse(fMonth %in% c("10", "11", "12"), "Fall", ifelse(fMonth %in% c("1", "2", "3"), "Winter", ifelse(fMonth %in% c("4", "5", "6"), "Spring", "Summer")))) %>%
  mutate(WYClass = recode(WYClass, "W" = "Wet", "A" = "Average", "D" = "Dry")) %>%
  rename(CPUEOrig = CPUE, 
         CPUE = CPUEAdj) %>%
  select(-c(WeatherCode:Volume, FieldComments, LabComments, FlagPhys:QCComments )) 
```

Questions

1. What are the key species we care about?
    - What species are most abundant? 
      * Orders: Diptera, Hygrophila, Coleoptera, Hemiptera, Amphipoda, Hymenoptera, Araneae, Collembola, Enchytraeida, Tubificida
      * Family: Physidae, Chironomidae, Hyalellidae, Corixidae, Dytiscidae, Enchytraeidae, Ceratopogonidae, Naididae, Daphniidae, Hydridae
    - What species are most consumed by salmon and splittail, blackfish, pikeminnow, striped bass?
        - Chironomidae (larval - Splittail, Pikeminnow, Salmon, adult = Salmon)
        - What do splittail eat? (earthworms, clams, insect larvae, amphipods, eggs)
        - Pikeminnow (Corixidae at small sizes)
        - Size of organism (?)
        - Reduce to organisms in greater than 5% of samples 
2. Overall CPUE trends by order, family, species, category
    - Year, year type
      - 2017 and 2019 higher CPUE than 2018 in STTD, opposite trend in SHR
      - Compared to 2014-2015 (dry years), 2017 much higher, but 2019 similar to 2014.
    - Season/Month 
    - Station
      - Higher during wet years. Similar during dry years and average years
3. Species specific CPUE trends
    - Year, year type
    - Season/Month
    - Station
4. Inundation plots and species composition. 
4. NMDS + permanova: species composition difference by station and year?
5. Joint species distribution models or CCA
  - Site, environmental variable, year?
6. Effect of flow and water temp on CPUE? - do we have flow data?

Filter out fish and Calanoids
```{r}
driftBugs <- drift %>%
  #mutate(Inundation2 = ifelse(lead(Inundation, 10) == "TRUE", "TRUE", Inundation),
  #       Inundation2 = replace(Inundation2, is.na(Inundation2), Inundation)) %>%
  mutate(Date = as.Date(Datetime),
         Year = year(Date),
         Month = month(Date),
         WY = ifelse(month(Date) > 9, Year + 1, Year)) %>%
  filter(Phylum != "Chordata",
         !Order %in% c("Calanoida", "Cyclopoida")) 
```

Complete dataset for all taxa - filled in for TaxonName, but mostly looking at order. 
```{r}
driftBugsComplete <- driftBugs %>%
  select(Date, WY, WYClass, Inundation, fWY, Station, fMonth, Season1, Season2, Season3, Order, Family, TaxonName, VolumeAdj, Count, CPUE) %>%
  filter(TaxonName != "") %>%
  complete(TaxonName, nesting(Date, WY, WYClass, Inundation,fWY, Station, fMonth, Order, Family, VolumeAdj, Season1, Season2, Season3), 
           fill = list(CPUE = 0, Count = 0)) %>%
  mutate(Order = ifelse(Order == "", "Other", Order),
         Family = ifelse(Family == "", "Other", Family))
```

Daily sum of CPUE (no distinction of taxonomy)
```{r}
driftDailyCPUE <- driftBugsComplete %>%
  group_by(Station, Inundation, Date, fWY, WY, WYClass, fMonth, Season1, Season2, Season3, VolumeAdj) %>%
  summarize(CPUEDaily = sum(CPUE),
            CountDaily = sum(Count)) %>%
  ungroup()
```

Calculate Daily CPUE by Order; Fill in zeroes
```{r}
driftOrderDaily <- driftBugsComplete %>%
  group_by(Station, Date, WY, WYClass, Inundation, fWY, Season1, Season2, Season3, fMonth, VolumeAdj, Order) %>%
  summarize(CPUE_Order = sum(CPUE),
            Count_Order = sum(Count)) %>%
  ungroup %>%
  complete(Station, Order, nesting(Date, WY, WYClass, Inundation, fWY, Season1, Season2, Season3, fMonth, VolumeAdj), 
           fill = list(CPUE_Order = 0, Count_Order = 0)) %>%
  rename(CPUEDaily = CPUE_Order,
         CountDaily = Count_Order)
```

Calculate Daily CPUE by Family; Fill in zeroes
```{r}
driftFamilyDaily <- driftBugsComplete %>%
  group_by(Station, Date, WY, WYClass, Inundation, fWY, Season1, Season2, Season3, fMonth, VolumeAdj, Family) %>%
  summarize(CPUE_Family = sum(CPUE),
            Count_Family = sum(Count)) %>%
  ungroup %>%
  complete(Station, Family, nesting(Date, WY, WYClass, Inundation, fWY, Season1, Season2, Season3, fMonth, VolumeAdj), 
           fill = list(CPUE_Family = 0, Count_Family = 0)) %>%
  rename(CPUEDaily = CPUE_Family,
         CountDaily = Count_Family)
```


Create lists for most abundant organisms
Family
```{r}
# Figure out total number of samples
samples <- driftBugs %>%
  select(Station, Date) %>%
  distinct() %>%
  group_by(Station, Date) %>%
  summarize(n = n())

# Fill in zeros for families
# Figure out proportion of samples present for each family
FamilyProp <- driftBugsComplete %>%
  select(Date, Family, CPUE) %>% 
  filter(Family != "") %>% 
  group_by(Date, Family) %>%
  summarize(CPUE_daily = sum(CPUE)) %>%
  ungroup() %>%
  complete(Family, nesting(Date), 
           fill = list(CPUE_daily = 0)) %>%
  mutate(ntotal = 144) %>%
  group_by(Family, ntotal) %>%
  summarize(zeros = sum(CPUE_daily == 0),
            propPresent = 1-round(zeros/ntotal,2))%>%
  unique() %>%
  ungroup()

# Filter to those in at least 10% of samples
FamilyLg <- FamilyProp %>%filter(propPresent>=.1)
  

```

Same for order
```{r}
OrderProp <- driftBugsComplete %>%
  select(Date, Order, CPUE) %>% 
  filter(Order != "") %>%
  group_by(Date, Order) %>%
  summarize(CPUE_daily = sum(CPUE)) %>%
  ungroup() %>%
  complete(Order, nesting(Date), fill = list(CPUE_daily = 0)) %>%
  mutate(ntotal = 144) %>%
  group_by(Order, ntotal) %>%
  summarize(zeros = sum(CPUE_daily == 0),
            propPresent = 1-round(zeros/ntotal,2))%>%
  unique() %>%
  ungroup()

# Filter to those in at least 10% samples
OrderLg <- OrderProp%>% filter(propPresent>=0.1) 
```

Make lists for filtering
```{r}
familyAbund <- pull(FamilyLg, Family)
orderAbund <- pull(OrderLg, Order)
orderIEP <- c("Diptera", "Hemiptera", "Amphipoda", "Hymenoptera", "Coleoptera", "Collembola")
```

Filter to different lists (last report, most abundant)
```{r}
# These are the ones in the last report
driftOrderIEP <- driftOrderDaily %>%
  filter(Order %in% orderIEP) 

# Drift Order Abundant
driftOrderAbund <- driftOrderDaily %>%
  filter(Order %in% orderAbund) 

# Drift Family Abundant
driftFamilyAbund <- driftFamilyDaily %>%
  filter(Family %in% familyAbund) 
```

Add inundation
```{r}
inundation2 <- dplyr::select(inundation, -c(StageHeight_FW:Overtopping_LIS)) %>%
  mutate(Inundation2 = ifelse(lead(Inundation, 10) == "TRUE", "TRUE", Inundation),
         Inundation_n = ifelse(Inundation2 == "TRUE", 175, 0),
         Inundation_mean = ifelse(Inundation2 == "TRUE", 25, 0),
         Inundation_log = ifelse(Inundation2 == "TRUE", 5, 0)) %>%
  filter(WY>2016 & WY <2020) %>%
  mutate(Date = lubridate::ymd(Date))%>%
  mutate(Year = year(Date),
         Month = month(Date),
         WY = ifelse(month(Date) > 9, Year + 1, Year)) 


driftBugsSum <- driftDailyCPUE %>%
  filter(Station == "STTD") %>%
  dplyr::select(-Inundation)

driftInund <- left_join(driftBugsSum, inundation2, by = c("Date", "WY"))
```


Write data
```{r}
write_csv(driftBugs, "WY2016_WY2019/data_clean/clean_drift_bugs.csv")
saveRDS(driftBugsComplete, "WY2016_WY2019/data_clean/clean_drift_bugs_complete.rds")
write_csv(driftDailyCPUE, "WY2016_WY2019/data_clean/clean_drift_daily_cpue.csv")
write_csv(driftFamilyAbund, "WY2016_WY2019/data_clean/clean_drift_family_abundant.csv")
write_csv(driftOrderAbund, "WY2016_WY2019/data_clean/clean_drift_order_abundant.csv")
write_csv(driftOrderIEP, "WY2016_WY2019/data_clean/clean_drift_order_iep.csv")

write_csv(driftInund, "WY2016_WY2019/data_clean/clean_drift_inund_sumCPUE.csv")
write_csv(inundation, "WY2016_WY2019/data_clean/inundation.csv")
write_csv(inundation2, "WY2016_WY2019/data_clean/inundation2.csv")


```

